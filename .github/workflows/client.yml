name: ERer Client

# main ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  # client ë””ë ‰í† ë¦¬ ë‚´ ë³€ê²½ ì‚¬í•­ ê°ì§€
  changes:
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë³€ê²½ ì‚¬í•­ í™•ì¸
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            client:
              - 'client/**'

  # client ë””ë ‰í† ë¦¬ ë³€ê²½ì´ ê°ì§€ë˜ë©´ ë¹Œë“œ ì‹¤í–‰
  build-client:
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GHCR ë¡œê·¸ì¸
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
          if [ $? -ne 0 ]; then
            echo "âŒ GHCR ë¡œê·¸ì¸ ì‹¤íŒ¨"
            exit 1
          fi
          echo "âœ… GHCR ë¡œê·¸ì¸ ì„±ê³µ"

      - name: í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCRì— í‘¸ì‹œ
        run: |
          echo "ğŸ—ï¸ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-client:latest ./client
          echo "ğŸš€ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ë¥¼ GHCRì— í‘¸ì‹œ ì¤‘..."
          docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-client:latest

      - name: í‘¸ì‹œí•œ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ í™•ì¸
        run: |
          echo "ğŸ” GHCRì— í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
          curl -H "Authorization: token ${{ secrets.GHCR_TOKEN }}" https://ghcr.io/v2/${{ secrets.GHCR_USERNAME }}/erer-client/tags/list || {
            echo "âŒ GHCRì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ í™•ì¸ ì‹¤íŒ¨"
            exit 1
          }
          echo "âœ… GHCRì— í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ"

  # ë¹Œë“œ ì™„ë£Œ í›„ EC2ì— ë°°í¬
  deploy-client:
    needs: build-client
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: í´ë¼ì´ì–¸íŠ¸ EC2 ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ í´ë¼ì´ì–¸íŠ¸ ë°°í¬ ì‹œì‘..."

            # âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            echo "ğŸ›‘ ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
            docker stop erer-client || true
            docker rm erer-client || true

            # âœ… ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            docker rmi ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-client:latest || true

            # âœ… ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            echo "â¬‡ï¸ ìµœì‹  í´ë¼ì´ì–¸íŠ¸ Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-client:latest || {
              echo "âŒ í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"
              exit 1
            }
            echo "âœ… í´ë¼ì´ì–¸íŠ¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

            # âœ… ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸš€ ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            docker run -d --name erer-client -p 3000:3000 --restart always ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-client:latest

            echo "âœ… í´ë¼ì´ì–¸íŠ¸ ë°°í¬ ì™„ë£Œ!"
