name: Deploy ERer Server

# main ë¸Œëœì¹˜ì— push ë°œìƒ ì‹œ ì‹¤í–‰
on:
  push:
    branches:
      - main

jobs:
  # server ë””ë ‰í† ë¦¬ ë‚´ ë³€ê²½ ì‚¬í•­ ê°ì§€
  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë³€ê²½ ì‚¬í•­ í™•ì¸
        id: filter
        uses: dorny/paths-filter@v2
        with:
          filters: |
            server:
              - 'server/**'

  # server ë””ë ‰í† ë¦¬ ë³€ê²½ì´ ê°ì§€ë˜ë©´ ë¹Œë“œ ì‹¤í–‰
  build-server:
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: GHCR ë¡œê·¸ì¸
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ secrets.GHCR_USERNAME }} --password-stdin
          if [ $? -ne 0 ]; then
            echo "âŒ GHCR ë¡œê·¸ì¸ ì‹¤íŒ¨"
            exit 1
          fi
          echo "âœ… GHCR ë¡œê·¸ì¸ ì„±ê³µ"

      - name: ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCRì— í‘¸ì‹œ
        run: |
          echo "ğŸ—ï¸ ì„œë²„ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-server:latest ./server
          echo "ğŸš€ ì„œë²„ ì´ë¯¸ì§€ë¥¼ GHCRì— í‘¸ì‹œ ì¤‘..."
          docker push ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-server:latest

      - name: í‘¸ì‹œí•œ ì„œë²„ ì´ë¯¸ì§€ í™•ì¸
        run: |
          echo "ğŸ” GHCRì— ì„œë²„ ì´ë¯¸ì§€ í™•ì¸ ì¤‘..."
          curl -H "Authorization: Bearer ${{ secrets.GHCR_TOKEN }}" https://ghcr.io/v2/${{ secrets.GHCR_USERNAME }}/erer-server/tags/list || {
            echo "âŒ GHCRì—ì„œ ì„œë²„ ì´ë¯¸ì§€ í™•ì¸ ì‹¤íŒ¨"
            exit 1
          }
          echo "âœ… GHCRì— ì„œë²„ ì´ë¯¸ì§€ í™•ì¸ ì™„ë£Œ"

  # ë¹Œë“œ ì™„ë£Œ í›„ EC2ì— ë°°í¬
  deploy-server:
    needs: build-server
    runs-on: ubuntu-latest
    steps:
      - name: ì„œë²„ EC2 ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ ì„œë²„ ë°°í¬ ì‹œì‘..."

            # âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            echo "ğŸ›‘ ê¸°ì¡´ ì„œë²„ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
            docker stop erer-server || true
            docker rm erer-server || true

            # âœ… ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ
            echo "ğŸ—‘ï¸ ê¸°ì¡´ Docker ì´ë¯¸ì§€ ì‚­ì œ ì¤‘..."
            docker rmi ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-server:latest || true

            # âœ… ìµœì‹  Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            echo "â¬‡ï¸ ìµœì‹  ì„œë²„ Docker ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            docker pull ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-server:latest || {
              echo "âŒ ì„œë²„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨"
              exit 1
            }
            echo "âœ… ì„œë²„ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

            # âœ… ê¸°ì¡´ .env íŒŒì¼ ì œê±°
            echo "ğŸ—‘ï¸ ê¸°ì¡´ .env íŒŒì¼ ì‚­ì œ ì¤‘..."
            rm -f /home/ubuntu/.env || true

            # âœ… ìƒˆë¡œìš´ .env íŒŒì¼ ìƒì„±
            echo "âœï¸ ìƒˆë¡œìš´ .env íŒŒì¼ ìƒì„± ì¤‘..."
            cat <<EOF > /home/ubuntu/.env
            DB_URL=${{ secrets.DB_URL }}
            DB_USERNAME=${{ secrets.DB_USERNAME }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            PORT=5000
            API_KEY=${{ secrets.API_KEY }}
            API_URL=${{ secrets.API_URL }}
            CURRENT_SEASON=${{ secrets.CURRENT_SEASON }}
            EOF
            echo "âœ… .env íŒŒì¼ ìƒì„± ì™„ë£Œ"

            # âœ… ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            echo "ğŸš€ ìƒˆë¡œìš´ ì„œë²„ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘..."
            docker run -d --name erer-server -p 5000:5000 \
              --env-file /home/ubuntu/.env \
              ghcr.io/${{ secrets.GHCR_USERNAME }}/erer-server:latest

            echo "âœ… ì„œë²„ ë°°í¬ ì™„ë£Œ!"
